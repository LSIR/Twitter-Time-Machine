{% extends "base_generic.html" %}

{% block content %}
<script>
	Date.prototype.yyyymmdd = function() {
		var mm = this.getMonth() + 1; // getMonth() is zero-based
		var dd = this.getDate();

		return [this.getFullYear(),
				(mm>9 ? '' : '0') + mm,
				(dd>9 ? '' : '0') + dd
				].join('-');
	};


	$(function () {
		$('[rel="tooltip"]').tooltip()
	})

	function intToK(x){
		if(x<1000)return ""+x;
		if(x>1E6)return ((x/1E6)+"M");
		return ((x/1000.0)+"K");
	}

	function defaultImage(img) {
		img.onerror = function() {};
		img.src = "https://banner2.cleanpng.com/20180715/yag/kisspng-question-mark-computer-icons-exclamation-mark-desk-question-mark-emoji-5b4bb794264216.8330599815316888521567.jpg"
	}

	let charts = {}
	let tcdata = {}

	function setLogscale(check, cid) {
		let chart = charts[cid]
		chart.options.scales.yAxes[0].type = check ? 'logarithmic' : 'linear'
		chart.update()
	}

	function distanceLinePoint(line_p1, line_p2, p) {
		//https://math.stackexchange.com/questions/422602/convert-two-points-to-line-eq-ax-by-c-0
		let a = line_p1['y']-line_p2['y']
		let b = line_p2['t']-line_p1['t']
		let c = line_p1['t']*line_p2['y']-line_p1['y']*line_p2['t']
		//https://fr.wikipedia.org/wiki/Distance_d%27un_point_%C3%A0_une_droite
		return Math.abs(a*p['t']+b*p['y']+c)/Math.sqrt(a*a+b*b) + (line_p1['t'] - p['t']) //added t delta for uniform distrib
	}

	function triangeArea(line_p1, line_p2, p) {
		//https://www.mathopenref.com/coordtrianglearea.html
		return Math.abs(line_p1['t']*(line_p2['y']-p['y']) + line_p2['t']*(p['y']-line_p1['y']) + p['t']*(line_p1['y']-line_p2['y'])) / 2 + (line_p1['t'] - p['t']);
	}

	function optimizePoints(cid, max) {


		let check = $("#optimize_"+cid)[0].checked
		let startDate = new Date($('#start'+cid).val()).getTime();
		let endDate = new Date($('#end'+cid).val()).getTime();
		let chart = charts[cid]
		let points = tcdata[cid].filter(x => x.t.getTime() >= startDate && x.t.getTime() <= endDate);
		if(points.length > max && check) {
			let peaks = {{ peaks }}
			let newPoints = [points[points.length-1], points[0]]; //the older points are at end of the array:/
			let hitterWeight = [];
			for(let i = 1; i < points.length-1; i++) {
				let idx = points.length-i-1
				if(peaks.includes(points[idx].t.getTime() / 1000)) {
					hitterWeight.push([idx, Number.MAX_VALUE]) // enforce that peak points are not optimized
				} else {
					//we make pairs of (index, hittingWeight)
					hitterWeight.push([idx, triangeArea(points[idx+1], points[idx], points[idx-1])]);
				}
			}
			hitterWeight.sort((a,b) => b[1]-a[1]) //sort by hitting weight
			for(let i = 0; i < max; i++) {
				newPoints.push(points[hitterWeight[i][0]])
			}
			newPoints.sort((a, b) => a.t - b.t)
			chart.data.datasets[0].data = newPoints
		} else {
			chart.data.datasets[0].data = points
		}
		chart.update(0)
	}

	function customRadius(context) {
		let index = context.dataIndex;
		let value = context.dataset.data[index];

		let peaks = {{ peaks }}

		return peaks.includes(value.t.getTime() / 1000) ?  20 : 5;
	}

	function makeHistoryChart(divID, data, xaxis, yaxis, click_callback) {
		let div = $("#"+divID)
		div.append('<canvas></canvas>');
		div.append('<div class="row" id="'+divID+'_controls"></div>')
		let ctx = $("#"+divID + " > canvas")[0].getContext("2d")
		tcdata[divID] = data
		let chart = new Chart(ctx, {
			type: 'line',
			data: {
				datasets: [{
					data: [],
					backgroundColor: "rgba(30,129,176, 0.5)"
				}], 
			},
			options: {
				elements: {
					line: {
						tension: 0, //disables bezier curves
					},
					point: {
						radius : customRadius,
            			display: true
					}
				},
				legend: {
					display: false
				},
				scales: {
					xAxes: [{
						type: 'time',
						time: {
							unit: 'year'
						},
						scaleLabel: {
							display: true,
							labelString: xaxis,
							fontSize: 25,
							fontColor: "rgba(30,129,176, 1)"
						}
					}],
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: yaxis,
							fontSize: 25,
							fontColor: "rgba(30,129,176, 1)"
						}
					}]
				}
			}
		})

		charts[divID] = chart 
		let controlRow = $("#"+divID+" > .row")
		controlRow.append('<div class="offset-1 col-2 form-switch">\
					<input onchange="setLogscale(this.checked, \''+divID+'\')" class="form-check-input" type="checkbox" id="logscale_'+divID+'">\
					<label class="form-check-label" for="logscale_'+divID+'">Logarithmic scale</label>\
					</div>')
		controlRow.append('<div class="col-2 form-switch">\
					<input onchange="optimizePoints(\''+divID+'\', 500)" checked class="form-check-input" type="checkbox" id="optimize_'+divID+'">\
					<label class="form-check-label" for="optimize_'+divID+'">Optimize Points</label>\
					</div>')
		let minDate = new Date(data[data.length-1].t).yyyymmdd()
		let maxDate = new Date(data[0].t).yyyymmdd();
		controlRow.append('<div class="col-3">\
								<label for="start'+divID+'">Start Date</label>\
								<input onchange="optimizePoints(\''+divID+'\', 500)" type="date" id="start'+divID+'" value="'+minDate+'" min="'+minDate+'" max="'+maxDate+'">\
							</div>')
		controlRow.append('<div class="col-3">\
								<label for="end'+divID+'">End Date</label>\
								<input onchange="optimizePoints(\''+divID+'\', 500)" type="date" id="end'+divID+'" value="'+maxDate+'" min="'+minDate+'" max="'+maxDate+'">\
							</div>')
		optimizePoints(divID, 500)

		if(click_callback !== undefined) {
			$("#"+divID + " > canvas")[0].onclick = function(evt) {
				var activePoints = charts[divID].getElementAtEvent(event);

				if (activePoints.length > 0) {
					var clickedDatasetIndex = activePoints[0]._datasetIndex;
					var clickedElementindex = activePoints[0]._index;
					var label = charts[divID].data.labels[clickedElementindex];
					var value = charts[divID].data.datasets[clickedDatasetIndex].data[clickedElementindex]; 
					click_callback(value)    
				}
			};
		}
	} 

	function followers_chart() {
		let history = JSON.parse("{{ history }}".replaceAll('&quot;', '\"'))

		let followers = history.map((x) => {
			let followers_count = x["details"]["followers_count"]
			let date = new Date(x["ts"] * 1000)
			return {t: date, y: followers_count}
		})
		followers = followers.reverse() //server gives us the history in ascending time order, we want the opposite for chart.js
		makeHistoryChart("followersChart", followers, "Time", "Number of followers", function(v) {
			alert(v.t)
		});
	}

	
</script>
<div class="row mt-4">
	<div class="offset-lg-1 col-lg-3 col-sm-12 col-12 shadow p-3 mb-5 bg-body rounded">
		<div class="row text-center">
			<div class="col-12">
				<img class="rounded-circle" id="pp" width="144" height="144" src="{{ pp_url }}" onerror="defaultImage(this)"/>
			</div>
		</div>
		<div class="row text-center">
			<div class="col-12">
				<h2>
					{{ name }}
				</h2>
			</div>
		</div>
		<div class="row text-center mb-3">
			<div class="col-12">
				<h5>
					@{{ username }}
				</h2>
			</div>
			<div class="row">
				<div class="col-1 offset-5">
					{{ verified |safe}}
				</div>
				<div class="col-1">
					{{ protected |safe}}
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-12 mt-3">
				<i class="bi bi-blockquote-left" rel="tooltip" title="User bio"></i> {{ bio }}
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				<i class="bi bi-geo-alt-fill" rel="tooltip" title="Location"></i> {{ location }}
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				<i class="bi bi-link" rel="tooltip" title="Profile's url"></i> {{ url }}
			</div>
		</div>

		<div class="row mb-3">
			<div class="col-12">
				<i class="bi bi-calendar-event" rel="tooltip" title="Account creation"></i> {{ created_at }}
			</div>
		</div>

		<div class="row text-center">
			<div class="col-12 mt-3">
				<a id="plink" href="https://twitter.com/{{ username }}" target="_blank" rel="noopener noreferrer">
					<button type="button" class="outlink btn-outline-primary btn">View on Tweeter</button>
				</a>
			</div>
		</div>
		
	</div>
	<div class="col-lg-8 col-sm-12" id="profile-secondary">
		<div class="row">
			<div class="col-3 text-center">
				<h4>
					{{ tweet_count }} Tweets
				</h4>
			</div>
			<div class="col-3 text-center">
				<h4>
					{{ following_count }} Following
				</h4>
			</div>
			<div class="col-3 text-center">
				<h4>
					{{ followers_count }} Followers
				</h4>
			</div>
			<div class="col-3 text-center">
				<h4>
					{{ likes_count }} Likes
				</h4>
			</div>
			<div class="col-12" id="followersChart">
				<script>followers_chart();</script>
			</div>
		</div>
	</div>
	<div class="offset-lg-1 col-lg-11 col-sm-12">
		And some more here
	</div>
</div>

{% endblock %}

