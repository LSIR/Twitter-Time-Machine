{% extends "base_generic.html" %}

{% block content %}
<script>
	$(function () {
		$('[rel="tooltip"]').tooltip()
	})

	function intToK(x){
		if(x<1000)return ""+x;
		if(x>1E6)return ((x/1E6)+"M");
		return ((x/1000.0)+"K");
	}

	function defaultImage(img) {
		img.onerror = function() {};
		img.src = "https://banner2.cleanpng.com/20180715/yag/kisspng-question-mark-computer-icons-exclamation-mark-desk-question-mark-emoji-5b4bb794264216.8330599815316888521567.jpg"
	}

	let charts = {}

	function setLogscale(check, cid) {
		let chart = charts[cid]
		chart.options.scales.yAxes[0].type = check.checked ? 'logarithmic' : 'linear'
		chart.update()
	}

	function makeHistoryChart(divID, data, xaxis, yaxis) {
		let div = $("#"+divID)
		div.append('<canvas></canvas>');
		div.append('<div class="row" id="'+divID+'_controls"></div>')
		let ctx = $("#"+divID + " > canvas")[0].getContext("2d")
		let chart = new Chart(ctx, {
			type: 'line',
			data: {
				datasets: [{
					data: data,
					backgroundColor: "rgba(30,129,176, 0.5)"
				}], 
			},
			options: {
				elements: {
					line: {
						tension: 0, //disables bezier curves
					}
				},
				legend: {
					display: false
				},
				scales: {
					xAxes: [{
						type: 'time',
						time: {
							unit: 'year'
						},
						scaleLabel: {
							display: true,
							labelString: xaxis,
							fontSize: 25,
							fontColor: "rgba(30,129,176, 1)"
						}
					}],
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: yaxis,
							fontSize: 25,
							fontColor: "rgba(30,129,176, 1)"
						}
					}]
				}
			}
		})

		charts[divID] = chart 

		let controlRow = $("#"+divID+" > .row")
		controlRow.append('<div class="col-3 form-switch">\
					<input onchange="setLogscale(this, \''+divID+'\')" class="form-check-input" type="checkbox" id="logscale_'+divID+'">\
					<label class="form-check-label" for="logscale_'+divID+'">Logarithmic scale</label>\
					</div>')
		controlRow.append('<div class="col-3 form-switch">\
					<input checked class="form-check-input" type="checkbox" id="optimize_'+divID+'">\
					<label class="form-check-label" for="optimize_'+divID+'">Optimize Points</label>\
					</div>')
	} 

	function followers_chart() {
		let history = JSON.parse("{{ history }}".replaceAll('&quot;', '\"'))

		let followers = history.map((x) => {
			let followers_count = x["details"]["followers_count"]
			let date = new Date(x["ts"] * 1000)
			return {t: date, y: followers_count}
		})
		followers = followers.sort((a, b) => b.t - a.t)
		makeHistoryChart("followersChart", followers, "Time", "Number of followers");
	}

	
</script>
<div class="row mt-4">
	<div class="offset-lg-1 col-lg-3 col-sm-12 col-12 shadow p-3 mb-5 bg-body rounded">
		<div class="row text-center">
			<div class="col-12">
				<img class="rounded-circle" id="pp" width="144" height="144" src="{{ pp_url }}" onerror="defaultImage(this)"/>
			</div>
		</div>
		<div class="row text-center">
			<div class="col-12">
				<h2>
					{{ name }}
				</h2>
			</div>
		</div>
		<div class="row text-center mb-3">
			<div class="col-12">
				<h5>
					@{{ username }}
				</h2>
			</div>
			<div class="row">
				<div class="col-1 offset-5">
					{{ verified |safe}}
				</div>
				<div class="col-1">
					{{ protected |safe}}
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-12 mt-3">
				<i class="bi bi-blockquote-left" rel="tooltip" title="User bio"></i> {{ bio }}
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				<i class="bi bi-geo-alt-fill" rel="tooltip" title="Location"></i> {{ location }}
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				<i class="bi bi-link" rel="tooltip" title="Profile's url"></i> {{ url }}
			</div>
		</div>

		<div class="row mb-3">
			<div class="col-12">
				<i class="bi bi-calendar-event" rel="tooltip" title="Account creation"></i> {{ created_at }}
			</div>
		</div>

		<div class="row text-center">
			<div class="col-12 mt-3">
				<a id="plink" href="https://twitter.com/{{ username }}" target="_blank" rel="noopener noreferrer">
					<button type="button" class="outlink btn-outline-primary btn">View on Tweeter</button>
				</a>
			</div>
		</div>
		
	</div>
	<div class="col-lg-8 col-sm-12" id="profile-secondary">
		<div class="row">
			<div class="col-3 text-center">
				<h4>
					{{ tweet_count }} Tweets
				</h4>
			</div>
			<div class="col-3 text-center">
				<h4>
					{{ following_count }} Following
				</h4>
			</div>
			<div class="col-3 text-center">
				<h4>
					{{ followers_count }} Followers
				</h4>
			</div>
			<div class="col-3 text-center">
				<h4>
					{{ likes_count }} Likes
				</h4>
			</div>
			<div class="col-12" id="followersChart">
				<script>followers_chart();</script>
			</div>
		</div>
	</div>
	<div class="offset-lg-1 col-lg-11 col-sm-12">
		And some more here
	</div>
</div>

{% endblock %}

